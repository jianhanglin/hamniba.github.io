---
layout: post
title: "Drupal网站性能问题"
description: 
category: Drupal
tags: drupal-7 field
---
<br/>

在开发Drupal项目中，发现请求访问服务器的响应速度越来越慢，在移动端访问网站提供的接口也变慢，甚至需要盯着屏幕三五秒钟页面才能加载出来，这显然是用户所不能接受的。在排除是否网络不佳的问题之后，开始在网站设计中找原因。通常来说，一个网站的数据量越大，当然请求数据库需要耗费的时间也就越长。可问题是，对于一个正在开发且还没有对外公开的项目，用户就那么几个，数据库中也还没有可以堪称海量的数据，为何请求会这么慢？不应该呀。  

据我分析推断，问题可能出在字段(field)上。如果一个Drupal网站里面有多个content type，每个content type里面当然可能存在相同类型的字段，比如图片类型。在一个团队项目中，团队成员在各自创建不同的content type的时候，有可能会给同一种类型的字段创建不同的名字（机读名）。
Drupal7的设计是针对每一个不同机读名的字段，会自动在数据库里面建一张以此名字命名的表。比如field name为`field_image`,数据库里面就会有一张名为`field_data_field_image`的表。当你使用同一种类型的字段只是创建了不同的名字，数据库就多出一些表，而这些表里面的每一列意义都一样，但是数据库里多出这么多冗余的表，这显然就给数据读取造成了不小的压力，即便是数据库高手，再怎么运用数据库优化技术也不如少建一些重复无意义的数据表来的快。

Drupal是不是太灵活了？灵活到你会觉得Drupal的世界到处是坑，稍不小心就陷下去了。像这个情况，与其造成字段混乱数据表重复这个麻烦，Drupal的设计为什么不针对同一种类型的字段只在数据库里面建一张表呢？所有此类型字段的数据都存储在这个表中，而对不同content type里面的同类型字段开发人员只需要起个不同的名字加以区分就可以了。对于团队开发，特别是团队成员各自创建content type的时候尤其需要注意，在创建字段的时候有个“选择一个现有字段”的选项可以避免字段冗余。

提到网站性能和数据库，我特意在网上搜索一下如何优化，竟偶然了解到一个超牛逼的开源数据库，Redis。它的牛逼之一在于性能，因为它竟然是将所有数据存储在内存里面！请求数据库的速度就可想而知可以多快了，跟数据存储在硬盘上的数据库对比简直就不是一个数量级上的。之二在于它是非关系型数据库，且数据存储方式是键值对，可以支持很多不同的数据结构类型。

这种数据库特别适合高并发高性能的网站，现在主流的Github,StackOverflow,Flickr,Instagram等大型网站都在用这个数据库。鉴于刚开始了解到这个数据库，我有两个小白问题：把数据都存储在内存里，那服务器突然断电了怎么办？对于海量数据，内存不够大怎么办？分布式？...这些小白问题肯定都有解决方案，有机会用到Redis，应该深入研究下。

<br/>
<br/>
<br/>
参考资料：
----------
* [让猪去飞-漫谈Drupal性能优化经验贴](http://www.drupal001.com/2011/09/let-drupal-fly/)
* [Redis官方网站](http://redis.io/)  

